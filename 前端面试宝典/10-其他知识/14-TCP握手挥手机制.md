# TCP三次握手与四次挥手机制

> TCP（传输控制协议）是面向连接的、可靠的传输层协议。理解三次握手和四次挥手是网络面试高频考点。

## 概念简介

- **三次握手（Three-way Handshake）**：建立TCP连接的过程，确保通信双方都具备发送和接收能力。
- **四次挥手（Four-way Handshake）**：断开TCP连接的过程，确保双方都能完成数据传输后安全断开。

---

## 一、三次握手过程

三次握手用于建立可靠的TCP连接，过程如下：

```
客户端                服务端
  |      SYN=1, seq=x      |
  |----------------------->|
  |                        |
  |   SYN=1, ACK=1, seq=y  |
  |   ack=x+1              |
  |<-----------------------|
  |                        |
  |      ACK=1, seq=x+1    |
  |      ack=y+1           |
  |----------------------->|
```

### 步骤详解

1. **第一次握手**：客户端发送SYN包（SYN=1, seq=x），进入SYN_SEND状态，表示请求建立连接。
2. **第二次握手**：服务端收到SYN，回复SYN+ACK包（SYN=1, ACK=1, seq=y, ack=x+1），进入SYN_RECV状态。
3. **第三次握手**：客户端收到SYN+ACK，发送ACK包（ACK=1, seq=x+1, ack=y+1），进入ESTABLISHED状态。服务端收到ACK后也进入ESTABLISHED状态，连接建立完成。

---

## 二、四次挥手过程

四次挥手用于优雅断开TCP连接，过程如下：

```
客户端                服务端
  |      FIN=1, seq=u      |
  |----------------------->|
  |                        |
  |      ACK=1, seq=v      |
  |      ack=u+1           |
  |<-----------------------|
  |                        |
  |      FIN=1, seq=v      |
  |<-----------------------|
  |                        |
  |      ACK=1, seq=u+1    |
  |      ack=v+1           |
  |----------------------->|
```

### 步骤详解

1. **第一次挥手**：客户端发送FIN包，表示数据发送完毕，进入FIN_WAIT_1状态。
2. **第二次挥手**：服务端收到FIN，回复ACK包，进入CLOSE_WAIT状态，客户端进入FIN_WAIT_2状态。
3. **第三次挥手**：服务端准备好后，发送FIN包，表示同意断开，进入LAST_ACK状态。
4. **第四次挥手**：客户端收到FIN，回复ACK包，进入TIME_WAIT状态，服务端收到ACK后进入CLOSED状态。客户端等待一段时间后也进入CLOSED状态。

---

## 三、为什么需要三次握手？

1. **防止历史连接请求干扰**：三次握手可以避免因网络延迟导致的旧连接请求包误触发新连接。
2. **确保双方收发能力正常**：
   - 第一次握手：客户端能发，服务端能收
   - 第二次握手：服务端能发，客户端能收
   - 第三次握手：客户端再次确认自己能发也能收
3. **可靠性保证**：三次确认，确保双方都已准备好，连接建立可靠。

---

## 四、为什么需要四次挥手？

1. **TCP是全双工协议**：连接的两端都需要单独关闭自己的发送通道。
2. **数据传输彻底完成**：
   - 一端发送FIN后，表示"我没有数据要发了"，但还能接收数据
   - 另一端ACK后，可能还有数据要发，等发完再发送FIN
   - 这样确保双方数据都能完整传输，不会丢失
3. **分步释放资源**：每一端都能独立地完成自己的关闭流程，保证连接优雅断开

---

## 五、面试常见问题

### 1. 为什么TCP连接建立要三次握手，而不是两次？

**答**：两次握手无法保证双方的收发能力都正常，且无法防止历史连接请求的干扰。三次握手能确保双方都能收发数据，连接建立更可靠。

### 2. 为什么断开连接要四次挥手？

**答**：因为TCP是全双工协议，双方都要单独关闭自己的发送通道。每一端都需要发送和确认FIN包，才能确保数据完整传输和连接优雅关闭。

### 3. TIME_WAIT状态的作用是什么？

**答**：TIME_WAIT状态保证最后一个ACK能被对方收到，防止延迟包影响后续新连接，并确保连接资源彻底释放。

---

**总结**：

- 三次握手确保连接可靠建立，防止历史包干扰
- 四次挥手保证双方数据完整传输，连接优雅关闭
- 掌握过程、状态和原理，是网络面试高频考点
