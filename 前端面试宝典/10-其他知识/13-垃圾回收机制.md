# åƒåœ¾å›æ”¶æœºåˆ¶

> åƒåœ¾å›æ”¶æ˜¯ç°ä»£ç¼–ç¨‹è¯­è¨€çš„æ ¸å¿ƒç‰¹æ€§ä¹‹ä¸€ï¼Œç›´æ¥å½±å“åº”ç”¨ç¨‹åºçš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

## æ¦‚å¿µä»‹ç»

åƒåœ¾å›æ”¶ï¼ˆGarbage Collection, GCï¼‰æ˜¯è®¡ç®—æœºç§‘å­¦ä¸­è‡ªåŠ¨ç®¡ç†å†…å­˜çš„ä¸€ç§æœºåˆ¶ã€‚å®ƒé€šè¿‡è¯†åˆ«å¹¶é‡Šæ”¾ç¨‹åºä¸å†ä½¿ç”¨çš„å†…å­˜å¯¹è±¡ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼å’Œå†…å­˜æº¢å‡ºã€‚åœ¨JavaScriptç­‰é«˜çº§è¯­è¨€ä¸­ï¼Œåƒåœ¾å›æ”¶å™¨ï¼ˆGarbage Collectorï¼‰ä¼šè‡ªåŠ¨è·Ÿè¸ªå†…å­˜åˆ†é…å’Œä½¿ç”¨æƒ…å†µï¼Œå®šæœŸæ¸…ç†æ— ç”¨çš„å†…å­˜ç©ºé—´ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦åƒåœ¾å›æ”¶ï¼Ÿ

åœ¨C/C++ç­‰ä½çº§è¯­è¨€ä¸­ï¼Œå¼€å‘è€…éœ€è¦æ‰‹åŠ¨ç®¡ç†å†…å­˜ï¼š
```c
// Cè¯­è¨€æ‰‹åŠ¨å†…å­˜ç®¡ç†
char* buffer = malloc(1024);  // åˆ†é…å†…å­˜
// ... ä½¿ç”¨å†…å­˜
free(buffer);                 // æ‰‹åŠ¨é‡Šæ”¾å†…å­˜
```

è€Œåœ¨JavaScriptä¸­ï¼Œå†…å­˜ç®¡ç†æ˜¯è‡ªåŠ¨çš„ï¼š
```javascript
/**
 * @description JavaScriptè‡ªåŠ¨å†…å­˜ç®¡ç†ç¤ºä¾‹
 */
function createData() {
  const data = new Array(1000).fill(0); // è‡ªåŠ¨åˆ†é…å†…å­˜
  return data;
} // å‡½æ•°ç»“æŸåï¼Œå±€éƒ¨å˜é‡dataå¯èƒ½è¢«åƒåœ¾å›æ”¶å™¨å›æ”¶
```

### å†…å­˜ç”Ÿå‘½å‘¨æœŸ

æ— è®ºå“ªç§ç¼–ç¨‹è¯­è¨€ï¼Œå†…å­˜çš„ç”Ÿå‘½å‘¨æœŸéƒ½åŒ…å«ä¸‰ä¸ªé˜¶æ®µï¼š

1. **åˆ†é…ï¼ˆAllocationï¼‰**ï¼šä¸ºå¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´
2. **ä½¿ç”¨ï¼ˆUsageï¼‰**ï¼šå¯¹å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œ
3. **é‡Šæ”¾ï¼ˆReleaseï¼‰**ï¼šé‡Šæ”¾ä¸å†éœ€è¦çš„å†…å­˜

```javascript
/**
 * @description å†…å­˜ç”Ÿå‘½å‘¨æœŸç¤ºä¾‹
 */
function memoryLifecycleDemo() {
  // 1. åˆ†é…é˜¶æ®µ - åˆ›å»ºå¯¹è±¡æ—¶è‡ªåŠ¨åˆ†é…å†…å­˜
  const user = {
    name: 'Alice',
    age: 25,
    hobbies: ['reading', 'coding']
  };

  // 2. ä½¿ç”¨é˜¶æ®µ - è¯»å–å’Œä¿®æ”¹å¯¹è±¡
  console.log(user.name); // è¯»å–
  user.age = 26;          // ä¿®æ”¹
  user.hobbies.push('gaming'); // ä¿®æ”¹æ•°ç»„

  // 3. é‡Šæ”¾é˜¶æ®µ - å‡½æ•°ç»“æŸåï¼Œuserå˜é‡è¶…å‡ºä½œç”¨åŸŸ
  // å¦‚æœæ²¡æœ‰å…¶ä»–å¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šè‡ªåŠ¨å›æ”¶å†…å­˜
}

memoryLifecycleDemo();
// æ‰§è¡Œç»“æœï¼šAlice
// userå¯¹è±¡åœ¨å‡½æ•°ç»“æŸåå¯èƒ½è¢«å›æ”¶
```

## æ ¸å¿ƒæœºåˆ¶

ç°ä»£åƒåœ¾å›æ”¶å™¨é‡‡ç”¨å¤šç§ç®—æ³•å’Œç­–ç•¥ï¼Œæ¯ç§éƒ½æœ‰å…¶é€‚ç”¨åœºæ™¯å’Œç‰¹ç‚¹ã€‚

### 1. å¼•ç”¨è®¡æ•°ï¼ˆReference Countingï¼‰

#### åŸºæœ¬åŸç†

å¼•ç”¨è®¡æ•°æ˜¯æœ€ç›´è§‚çš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚å®ƒä¸ºæ¯ä¸ªå¯¹è±¡ç»´æŠ¤ä¸€ä¸ªå¼•ç”¨è®¡æ•°å™¨ï¼Œè®°å½•æœ‰å¤šå°‘ä¸ªå˜é‡æŒ‡å‘è¯¥å¯¹è±¡ã€‚å½“å¼•ç”¨è®¡æ•°ä¸º0æ—¶ï¼Œè¯´æ˜å¯¹è±¡ä¸å†è¢«ä½¿ç”¨ï¼Œå¯ä»¥ç«‹å³å›æ”¶ã€‚

```javascript
/**
 * @description å¼•ç”¨è®¡æ•°æœºåˆ¶æ¨¡æ‹Ÿ
 */
class ReferenceCountingDemo {
  constructor() {
    this.objects = new Map(); // å­˜å‚¨å¯¹è±¡å’Œå…¶å¼•ç”¨è®¡æ•°
  }

  /**
   * åˆ›å»ºå¯¹è±¡å¹¶è®¾ç½®åˆå§‹å¼•ç”¨è®¡æ•°
   */
  createObject(id, data) {
    this.objects.set(id, {
      data: data,
      refCount: 1 // åˆå§‹å¼•ç”¨è®¡æ•°ä¸º1
    });
    console.log(`å¯¹è±¡${id}å·²åˆ›å»ºï¼Œå¼•ç”¨è®¡æ•°ï¼š1`);
  }

  /**
   * å¢åŠ å¯¹è±¡çš„å¼•ç”¨è®¡æ•°
   */
  addReference(id) {
    const obj = this.objects.get(id);
    if (obj) {
      obj.refCount++;
      console.log(`å¯¹è±¡${id}å¼•ç”¨è®¡æ•°å¢åŠ è‡³ï¼š${obj.refCount}`);
    }
  }

  /**
   * å‡å°‘å¯¹è±¡çš„å¼•ç”¨è®¡æ•°ï¼Œä¸º0æ—¶è‡ªåŠ¨å›æ”¶
   */
  removeReference(id) {
    const obj = this.objects.get(id);
    if (obj) {
      obj.refCount--;
      console.log(`å¯¹è±¡${id}å¼•ç”¨è®¡æ•°å‡å°‘è‡³ï¼š${obj.refCount}`);

      if (obj.refCount === 0) {
        this.objects.delete(id);
        console.log(`å¯¹è±¡${id}å·²è¢«å›æ”¶`);
      }
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const rc = new ReferenceCountingDemo();
rc.createObject('obj1', { name: 'test' }); // åˆ›å»ºå¯¹è±¡
rc.addReference('obj1');                   // å¢åŠ å¼•ç”¨
rc.removeReference('obj1');                // å‡å°‘å¼•ç”¨
rc.removeReference('obj1');                // å¼•ç”¨è®¡æ•°å½’é›¶ï¼Œå¯¹è±¡è¢«å›æ”¶

// æ‰§è¡Œç»“æœï¼š
// å¯¹è±¡obj1å·²åˆ›å»ºï¼Œå¼•ç”¨è®¡æ•°ï¼š1
// å¯¹è±¡obj1å¼•ç”¨è®¡æ•°å¢åŠ è‡³ï¼š2
// å¯¹è±¡obj1å¼•ç”¨è®¡æ•°å‡å°‘è‡³ï¼š1
// å¯¹è±¡obj1å¼•ç”¨è®¡æ•°å‡å°‘è‡³ï¼š0
// å¯¹è±¡obj1å·²è¢«å›æ”¶
```

#### å¾ªç¯å¼•ç”¨é—®é¢˜

å¼•ç”¨è®¡æ•°çš„æœ€å¤§é—®é¢˜æ˜¯æ— æ³•å¤„ç†å¾ªç¯å¼•ç”¨ï¼š

```javascript
/**
 * @description å¾ªç¯å¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼ç¤ºä¾‹
 */
function createCircularReference() {
  const objA = { name: 'A', ref: null };
  const objB = { name: 'B', ref: null };

  // åˆ›å»ºå¾ªç¯å¼•ç”¨
  objA.ref = objB; // objAå¼•ç”¨objB
  objB.ref = objA; // objBå¼•ç”¨objA

  console.log('å¾ªç¯å¼•ç”¨å·²åˆ›å»ºï¼š');
  console.log('objA.ref.name:', objA.ref.name); // è¾“å‡ºï¼šB
  console.log('objB.ref.name:', objB.ref.name); // è¾“å‡ºï¼šA

  // å‡½æ•°ç»“æŸåï¼ŒobjAå’ŒobjBç›¸äº’å¼•ç”¨ï¼Œå¼•ç”¨è®¡æ•°æ°¸è¿œä¸ä¸º0
  // åœ¨çº¯å¼•ç”¨è®¡æ•°ç³»ç»Ÿä¸­ï¼Œè¿™ä¸¤ä¸ªå¯¹è±¡æ°¸è¿œä¸ä¼šè¢«å›æ”¶
}

createCircularReference();

// æ›´å¤æ‚çš„å¾ªç¯å¼•ç”¨ç¤ºä¾‹
function complexCircularReference() {
  // åˆ›å»ºDOMå…ƒç´ å’Œäº‹ä»¶å¤„ç†å™¨çš„å¾ªç¯å¼•ç”¨
  const element = document.createElement('div');
  const data = { value: 'important data' };

  // äº‹ä»¶å¤„ç†å™¨æŒæœ‰dataçš„å¼•ç”¨
  element.onclick = function() {
    console.log(data.value);
  };

  // dataæŒæœ‰elementçš„å¼•ç”¨
  data.element = element;

  // è¿™ç§æ¨¡å¼åœ¨æ—©æœŸIEæµè§ˆå™¨ä¸­ä¼šå¯¼è‡´å†…å­˜æ³„æ¼
  console.log('å¤æ‚å¾ªç¯å¼•ç”¨å·²åˆ›å»º');
}
```

### 2. æ ‡è®°-æ¸…é™¤ï¼ˆMark-Sweepï¼‰

#### åŸºæœ¬åŸç†

æ ‡è®°-æ¸…é™¤ç®—æ³•æ˜¯ç°ä»£JavaScriptå¼•æ“æœ€å¸¸ç”¨çš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚å®ƒé€šè¿‡ä»æ ¹å¯¹è±¡å¼€å§‹éå†æ‰€æœ‰å¯è¾¾å¯¹è±¡æ¥ç¡®å®šå“ªäº›å¯¹è±¡ä»åœ¨ä½¿ç”¨ã€‚

```javascript
/**
 * @description æ ‡è®°-æ¸…é™¤ç®—æ³•æ¨¡æ‹Ÿ
 */
class MarkSweepGC {
  constructor() {
    this.heap = new Map(); // æ¨¡æ‹Ÿå †å†…å­˜
    this.roots = new Set(); // æ ¹å¯¹è±¡é›†åˆ
  }

  /**
   * åˆ†é…å¯¹è±¡åˆ°å †ä¸­
   */
  allocate(id, data, refs = []) {
    this.heap.set(id, {
      data: data,
      refs: refs,      // è¯¥å¯¹è±¡å¼•ç”¨çš„å…¶ä»–å¯¹è±¡
      marked: false    // æ ‡è®°ä½ï¼Œç”¨äºGC
    });
    console.log(`å¯¹è±¡${id}å·²åˆ†é…åˆ°å †ä¸­`);
  }

  /**
   * å°†å¯¹è±¡æ·»åŠ åˆ°æ ¹é›†åˆ
   */
  addRoot(id) {
    this.roots.add(id);
    console.log(`å¯¹è±¡${id}å·²æ·»åŠ åˆ°æ ¹é›†åˆ`);
  }

  /**
   * æ ‡è®°é˜¶æ®µï¼šä»æ ¹å¯¹è±¡å¼€å§‹æ ‡è®°æ‰€æœ‰å¯è¾¾å¯¹è±¡
   */
  mark() {
    console.log('\nå¼€å§‹æ ‡è®°é˜¶æ®µ...');

    // é‡ç½®æ‰€æœ‰å¯¹è±¡çš„æ ‡è®°
    for (const [id, obj] of this.heap) {
      obj.marked = false;
    }

    // ä»æ ¹å¯¹è±¡å¼€å§‹æ·±åº¦ä¼˜å…ˆéå†
    for (const rootId of this.roots) {
      this.markObject(rootId);
    }
  }

  /**
   * é€’å½’æ ‡è®°å¯¹è±¡åŠå…¶å¼•ç”¨çš„å¯¹è±¡
   */
  markObject(id) {
    const obj = this.heap.get(id);
    if (!obj || obj.marked) return;

    obj.marked = true;
    console.log(`æ ‡è®°å¯¹è±¡${id}`);

    // é€’å½’æ ‡è®°å¼•ç”¨çš„å¯¹è±¡
    for (const refId of obj.refs) {
      this.markObject(refId);
    }
  }

  /**
   * æ¸…é™¤é˜¶æ®µï¼šå›æ”¶æœªæ ‡è®°çš„å¯¹è±¡
   */
  sweep() {
    console.log('\nå¼€å§‹æ¸…é™¤é˜¶æ®µ...');
    const toDelete = [];

    for (const [id, obj] of this.heap) {
      if (!obj.marked) {
        toDelete.push(id);
      }
    }

    for (const id of toDelete) {
      this.heap.delete(id);
      console.log(`å›æ”¶å¯¹è±¡${id}`);
    }

    console.log(`\nåƒåœ¾å›æ”¶å®Œæˆï¼Œå‰©ä½™å¯¹è±¡ï¼š${this.heap.size}ä¸ª`);
  }

  /**
   * æ‰§è¡Œå®Œæ•´çš„åƒåœ¾å›æ”¶
   */
  collectGarbage() {
    console.log('=== å¼€å§‹åƒåœ¾å›æ”¶ ===');
    this.mark();
    this.sweep();
    console.log('=== åƒåœ¾å›æ”¶ç»“æŸ ===\n');
  }

  /**
   * æ˜¾ç¤ºå½“å‰å †çŠ¶æ€
   */
  showHeap() {
    console.log('å½“å‰å †çŠ¶æ€ï¼š');
    for (const [id, obj] of this.heap) {
      console.log(`  ${id}: ${JSON.stringify(obj.data)}, å¼•ç”¨: [${obj.refs.join(', ')}]`);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const gc = new MarkSweepGC();

// åˆ›å»ºå¯¹è±¡å›¾
gc.allocate('A', { name: 'Object A' }, ['B', 'C']);
gc.allocate('B', { name: 'Object B' }, ['D']);
gc.allocate('C', { name: 'Object C' }, []);
gc.allocate('D', { name: 'Object D' }, ['C']);
gc.allocate('E', { name: 'Object E' }, ['F']); // å­¤ç«‹å¯¹è±¡
gc.allocate('F', { name: 'Object F' }, ['E']); // å¾ªç¯å¼•ç”¨ä½†ä¸å¯è¾¾

// è®¾ç½®æ ¹å¯¹è±¡
gc.addRoot('A');

// æ˜¾ç¤ºåˆå§‹çŠ¶æ€
gc.showHeap();

// æ‰§è¡Œåƒåœ¾å›æ”¶
gc.collectGarbage();

// æ˜¾ç¤ºå›æ”¶åçŠ¶æ€
gc.showHeap();

// æ‰§è¡Œç»“æœï¼š
// å¯¹è±¡Aå·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Bå·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Cå·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Då·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Eå·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Få·²åˆ†é…åˆ°å †ä¸­
// å¯¹è±¡Aå·²æ·»åŠ åˆ°æ ¹é›†åˆ
// å½“å‰å †çŠ¶æ€ï¼š
//   A: {"name":"Object A"}, å¼•ç”¨: [B, C]
//   B: {"name":"Object B"}, å¼•ç”¨: [D]
//   C: {"name":"Object C"}, å¼•ç”¨: []
//   D: {"name":"Object D"}, å¼•ç”¨: [C]
//   E: {"name":"Object E"}, å¼•ç”¨: [F]
//   F: {"name":"Object F"}, å¼•ç”¨: [E]
// === å¼€å§‹åƒåœ¾å›æ”¶ ===
//
// å¼€å§‹æ ‡è®°é˜¶æ®µ...
// æ ‡è®°å¯¹è±¡A
// æ ‡è®°å¯¹è±¡B
// æ ‡è®°å¯¹è±¡D
// æ ‡è®°å¯¹è±¡C
//
// å¼€å§‹æ¸…é™¤é˜¶æ®µ...
// å›æ”¶å¯¹è±¡E
// å›æ”¶å¯¹è±¡F
//
// åƒåœ¾å›æ”¶å®Œæˆï¼Œå‰©ä½™å¯¹è±¡ï¼š4ä¸ª
// === åƒåœ¾å›æ”¶ç»“æŸ ===
//
// å½“å‰å †çŠ¶æ€ï¼š
//   A: {"name":"Object A"}, å¼•ç”¨: [B, C]
//   B: {"name":"Object B"}, å¼•ç”¨: [D]
//   C: {"name":"Object C"}, å¼•ç”¨: []
//   D: {"name":"Object D"}, å¼•ç”¨: [C]
```

#### ä¸‰è‰²æ ‡è®°ç®—æ³•

ä¸ºäº†åœ¨å¹¶å‘ç¯å¢ƒä¸­æ›´å¥½åœ°å·¥ä½œï¼Œç°ä»£åƒåœ¾å›æ”¶å™¨ä½¿ç”¨ä¸‰è‰²æ ‡è®°ç®—æ³•ï¼š

```javascript
/**
 * @description ä¸‰è‰²æ ‡è®°ç®—æ³•æ¼”ç¤º
 */
class TriColorGC {
  constructor() {
    this.objects = new Map();
    this.white = new Set(); // ç™½è‰²ï¼šæœªè®¿é—®çš„å¯¹è±¡
    this.gray = new Set();  // ç°è‰²ï¼šå·²è®¿é—®ä½†å­å¯¹è±¡æœªå®Œå…¨è®¿é—®çš„å¯¹è±¡
    this.black = new Set(); // é»‘è‰²ï¼šå·²å®Œå…¨è®¿é—®çš„å¯¹è±¡
  }

  /**
   * æ·»åŠ å¯¹è±¡
   */
  addObject(id, refs = []) {
    this.objects.set(id, refs);
    this.white.add(id); // æ–°å¯¹è±¡åˆå§‹ä¸ºç™½è‰²
  }

  /**
   * æ‰§è¡Œä¸‰è‰²æ ‡è®°
   */
  triColorMark(roots) {
    console.log('å¼€å§‹ä¸‰è‰²æ ‡è®°ç®—æ³•...\n');

    // åˆå§‹åŒ–ï¼šæ‰€æœ‰å¯¹è±¡éƒ½æ˜¯ç™½è‰²
    this.white = new Set(this.objects.keys());
    this.gray = new Set();
    this.black = new Set();

    // å°†æ ¹å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
    for (const root of roots) {
      if (this.white.has(root)) {
        this.white.delete(root);
        this.gray.add(root);
      }
    }

    console.log('åˆå§‹çŠ¶æ€ï¼š');
    this.printColors();

    // å¤„ç†ç°è‰²å¯¹è±¡ç›´åˆ°ç°è‰²é›†åˆä¸ºç©º
    let step = 1;
    while (this.gray.size > 0) {
      console.log(`\næ­¥éª¤ ${step}:`);

      // é€‰æ‹©ä¸€ä¸ªç°è‰²å¯¹è±¡
      const current = this.gray.values().next().value;
      const refs = this.objects.get(current) || [];

      // å°†å…¶å¼•ç”¨çš„ç™½è‰²å¯¹è±¡æ ‡è®°ä¸ºç°è‰²
      for (const ref of refs) {
        if (this.white.has(ref)) {
          this.white.delete(ref);
          this.gray.add(ref);
          console.log(`  å¯¹è±¡${ref}ä»ç™½è‰²å˜ä¸ºç°è‰²ï¼ˆè¢«${current}å¼•ç”¨ï¼‰`);
        }
      }

      // å°†å½“å‰å¯¹è±¡ä»ç°è‰²å˜ä¸ºé»‘è‰²
      this.gray.delete(current);
      this.black.add(current);
      console.log(`  å¯¹è±¡${current}ä»ç°è‰²å˜ä¸ºé»‘è‰²`);

      this.printColors();
      step++;
    }

    console.log(`\næ ‡è®°å®Œæˆï¼ç™½è‰²å¯¹è±¡å°†è¢«å›æ”¶ï¼š[${Array.from(this.white).join(', ')}]`);
  }

  /**
   * æ‰“å°å½“å‰é¢œè‰²çŠ¶æ€
   */
  printColors() {
    console.log(`  ç™½è‰²: [${Array.from(this.white).join(', ')}]`);
    console.log(`  ç°è‰²: [${Array.from(this.gray).join(', ')}]`);
    console.log(`  é»‘è‰²: [${Array.from(this.black).join(', ')}]`);
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const triGC = new TriColorGC();

// æ„å»ºå¯¹è±¡å›¾
triGC.addObject('root', ['A', 'B']);
triGC.addObject('A', ['C']);
triGC.addObject('B', ['C', 'D']);
triGC.addObject('C', []);
triGC.addObject('D', []);
triGC.addObject('E', ['F']); // ä¸å¯è¾¾å¯¹è±¡
triGC.addObject('F', []);    // ä¸å¯è¾¾å¯¹è±¡

// æ‰§è¡Œä¸‰è‰²æ ‡è®°
triGC.triColorMark(['root']);

// æ‰§è¡Œç»“æœï¼š
// å¼€å§‹ä¸‰è‰²æ ‡è®°ç®—æ³•...
//
// åˆå§‹çŠ¶æ€ï¼š
//   ç™½è‰²: [root, A, B, C, D, E, F]
//   ç°è‰²: [root]
//   é»‘è‰²: []
//
// æ­¥éª¤ 1:
//   å¯¹è±¡Aä»ç™½è‰²å˜ä¸ºç°è‰²ï¼ˆè¢«rootå¼•ç”¨ï¼‰
//   å¯¹è±¡Bä»ç™½è‰²å˜ä¸ºç°è‰²ï¼ˆè¢«rootå¼•ç”¨ï¼‰
//   å¯¹è±¡rootä»ç°è‰²å˜ä¸ºé»‘è‰²
//   ç™½è‰²: [C, D, E, F]
//   ç°è‰²: [A, B]
//   é»‘è‰²: [root]
//
// æ­¥éª¤ 2:
//   å¯¹è±¡Cä»ç™½è‰²å˜ä¸ºç°è‰²ï¼ˆè¢«Aå¼•ç”¨ï¼‰
//   å¯¹è±¡Aä»ç°è‰²å˜ä¸ºé»‘è‰²
//   ç™½è‰²: [D, E, F]
//   ç°è‰²: [B, C]
//   é»‘è‰²: [root, A]
//
// æ­¥éª¤ 3:
//   å¯¹è±¡Dä»ç™½è‰²å˜ä¸ºç°è‰²ï¼ˆè¢«Bå¼•ç”¨ï¼‰
//   å¯¹è±¡Bä»ç°è‰²å˜ä¸ºé»‘è‰²
//   ç™½è‰²: [E, F]
//   ç°è‰²: [C, D]
//   é»‘è‰²: [root, A, B]
//
// æ­¥éª¤ 4:
//   å¯¹è±¡Cä»ç°è‰²å˜ä¸ºé»‘è‰²
//   ç™½è‰²: [E, F]
//   ç°è‰²: [D]
//   é»‘è‰²: [root, A, B, C]
//
// æ­¥éª¤ 5:
//   å¯¹è±¡Dä»ç°è‰²å˜ä¸ºé»‘è‰²
//   ç™½è‰²: [E, F]
//   ç°è‰²: []
//   é»‘è‰²: [root, A, B, C, D]
//
// æ ‡è®°å®Œæˆï¼ç™½è‰²å¯¹è±¡å°†è¢«å›æ”¶ï¼š[E, F]
```

### 3. æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰

æ ‡è®°-æ•´ç†ç®—æ³•åœ¨æ ‡è®°-æ¸…é™¤çš„åŸºç¡€ä¸Šå¢åŠ äº†å†…å­˜æ•´ç†æ­¥éª¤ï¼Œè§£å†³å†…å­˜ç¢ç‰‡åŒ–é—®é¢˜ï¼š

```javascript
/**
 * @description æ ‡è®°-æ•´ç†ç®—æ³•æ¨¡æ‹Ÿ
 */
class MarkCompactGC {
  constructor(heapSize = 20) {
    this.heap = new Array(heapSize).fill(null); // æ¨¡æ‹Ÿè¿ç»­å†…å­˜
    this.heapSize = heapSize;
    this.allocPtr = 0; // åˆ†é…æŒ‡é’ˆ
    this.objects = new Map(); // å¯¹è±¡æ˜ å°„è¡¨
  }

  /**
   * åœ¨å †ä¸­åˆ†é…å¯¹è±¡
   */
  allocate(id, size, refs = []) {
    if (this.allocPtr + size > this.heapSize) {
      console.log(`å†…å­˜ä¸è¶³ï¼Œæ— æ³•åˆ†é…å¯¹è±¡${id}`);
      return false;
    }

    const startAddr = this.allocPtr;
    const obj = {
      id,
      refs,
      size,
      startAddr,
      marked: false
    };

    // åœ¨å †ä¸­æ ‡è®°å ç”¨ç©ºé—´
    for (let i = 0; i < size; i++) {
      this.heap[startAddr + i] = id;
    }

    this.objects.set(id, obj);
    this.allocPtr += size;

    console.log(`å¯¹è±¡${id}å·²åˆ†é…ï¼Œåœ°å€ï¼š${startAddr}-${startAddr + size - 1}`);
    return true;
  }

  /**
   * æ ‡è®°é˜¶æ®µ
   */
  mark(roots) {
    console.log('\n=== æ ‡è®°é˜¶æ®µ ===');

    // é‡ç½®æ ‡è®°
    for (const obj of this.objects.values()) {
      obj.marked = false;
    }

    // ä»æ ¹å¼€å§‹æ ‡è®°
    for (const rootId of roots) {
      this.markObject(rootId);
    }
  }

  /**
   * é€’å½’æ ‡è®°å¯¹è±¡
   */
  markObject(id) {
    const obj = this.objects.get(id);
    if (!obj || obj.marked) return;

    obj.marked = true;
    console.log(`æ ‡è®°å¯¹è±¡${id}`);

    for (const refId of obj.refs) {
      this.markObject(refId);
    }
  }

  /**
   * æ•´ç†é˜¶æ®µï¼šç§»åŠ¨å­˜æ´»å¯¹è±¡ï¼Œæ¶ˆé™¤ç¢ç‰‡
   */
  compact() {
    console.log('\n=== æ•´ç†é˜¶æ®µ ===');

    // æ¸…ç©ºå †
    this.heap.fill(null);

    let newAllocPtr = 0;
    const addressMapping = new Map(); // æ—§åœ°å€åˆ°æ–°åœ°å€çš„æ˜ å°„

    // æŒ‰æ ‡è®°çŠ¶æ€æ•´ç†å¯¹è±¡
    for (const [id, obj] of this.objects) {
      if (obj.marked) {
        const oldAddr = obj.startAddr;
        const newAddr = newAllocPtr;

        // æ›´æ–°å¯¹è±¡åœ°å€
        obj.startAddr = newAddr;
        addressMapping.set(oldAddr, newAddr);

        // åœ¨æ–°ä½ç½®æ”¾ç½®å¯¹è±¡
        for (let i = 0; i < obj.size; i++) {
          this.heap[newAddr + i] = id;
        }

        newAllocPtr += obj.size;
        console.log(`å¯¹è±¡${id}ä»åœ°å€${oldAddr}ç§»åŠ¨åˆ°${newAddr}`);
      } else {
        // åˆ é™¤æœªæ ‡è®°çš„å¯¹è±¡
        this.objects.delete(id);
        console.log(`åˆ é™¤å¯¹è±¡${id}`);
      }
    }

    this.allocPtr = newAllocPtr;
    console.log(`å†…å­˜æ•´ç†å®Œæˆï¼Œæ–°çš„åˆ†é…æŒ‡é’ˆï¼š${this.allocPtr}`);
  }

  /**
   * æ‰§è¡Œæ ‡è®°-æ•´ç†åƒåœ¾å›æ”¶
   */
  collect(roots) {
    console.log('\n#################### å¼€å§‹æ ‡è®°-æ•´ç†GC ####################');
    this.showHeapState();
    this.mark(roots);
    this.compact();
    this.showHeapState();
    console.log('#################### GCå®Œæˆ ####################\n');
  }

  /**
   * æ˜¾ç¤ºå †çŠ¶æ€
   */
  showHeapState() {
    console.log('\nå½“å‰å †çŠ¶æ€ï¼š');
    console.log('åœ°å€: ' + Array.from({length: this.heapSize}, (_, i) =>
      i.toString().padStart(2, '0')).join(' '));
    console.log('å†…å®¹: ' + this.heap.map(cell =>
      cell ? cell.padStart(2, ' ') : '--').join(' '));
    console.log(`å·²ä½¿ç”¨ï¼š${this.allocPtr}/${this.heapSize}`);

    console.log('\nå¯¹è±¡ä¿¡æ¯ï¼š');
    for (const [id, obj] of this.objects) {
      console.log(`  ${id}: åœ°å€${obj.startAddr}-${obj.startAddr + obj.size - 1}, ` +
                  `å¤§å°${obj.size}, å¼•ç”¨[${obj.refs.join(',')}], ` +
                  `æ ‡è®°${obj.marked ? 'âœ“' : 'âœ—'}`);
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const markCompactGC = new MarkCompactGC(20);

// åˆ†é…ä¸€äº›å¯¹è±¡
markCompactGC.allocate('A', 3, ['B']);
markCompactGC.allocate('B', 2, ['C']);
markCompactGC.allocate('C', 4, []);
markCompactGC.allocate('D', 2, []); // åƒåœ¾å¯¹è±¡
markCompactGC.allocate('E', 3, ['F']);
markCompactGC.allocate('F', 2, []); // åƒåœ¾å¯¹è±¡

// æ‰§è¡Œåƒåœ¾å›æ”¶ï¼Œåªæœ‰Aæ˜¯æ ¹å¯¹è±¡
markCompactGC.collect(['A']);

// å†åˆ†é…ä¸€ä¸ªå¯¹è±¡ï¼ŒéªŒè¯å†…å­˜æ•´ç†æ•ˆæœ
console.log('å°è¯•åˆ†é…æ–°å¯¹è±¡Gï¼ˆå¤§å°5ï¼‰ï¼š');
markCompactGC.allocate('G', 5, []);
markCompactGC.showHeapState();

// æ‰§è¡Œç»“æœå±•ç¤ºå†…å­˜æ•´ç†å‰åçš„å¯¹æ¯”ï¼Œå¯ä»¥çœ‹åˆ°ï¼š
// 1. æ ‡è®°é˜¶æ®µæ­£ç¡®è¯†åˆ«äº†å­˜æ´»å¯¹è±¡Aã€Bã€C
// 2. æ•´ç†é˜¶æ®µå°†å­˜æ´»å¯¹è±¡ç§»åŠ¨åˆ°å†…å­˜å‰ç«¯ï¼Œæ¶ˆé™¤äº†ç¢ç‰‡
// 3. æ•´ç†åå¯ä»¥åˆ†é…æ›´å¤§çš„è¿ç»­å†…å­˜ç©ºé—´
```

### 4. åˆ†ä»£å›æ”¶ï¼ˆGenerational Collectionï¼‰

åˆ†ä»£å›æ”¶æ˜¯ç°ä»£åƒåœ¾å›æ”¶å™¨çš„æ ¸å¿ƒç­–ç•¥ï¼ŒåŸºäº"å¤§å¤šæ•°å¯¹è±¡æ­»å¾—å¾ˆå¿«"çš„è§‚å¯Ÿï¼š

```javascript
/**
 * @description åˆ†ä»£åƒåœ¾å›æ”¶æ¨¡æ‹Ÿ
 * æ¨¡æ‹ŸV8å¼•æ“çš„æ–°ç”Ÿä»£å’Œè€ç”Ÿä»£ç®¡ç†
 */
class GenerationalGC {
  constructor() {
    // æ–°ç”Ÿä»£ï¼šåˆ†ä¸ºFromç©ºé—´å’ŒToç©ºé—´
    this.youngGen = {
      fromSpace: new Map(),
      toSpace: new Map(),
      maxSize: 10,
      currentSize: 0
    };

    // è€ç”Ÿä»£ï¼šä½¿ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•
    this.oldGen = {
      objects: new Map(),
      maxSize: 50,
      currentSize: 0
    };

    this.allocationCount = 0;
    this.minorGCCount = 0; // æ–°ç”Ÿä»£GCæ¬¡æ•°
    this.majorGCCount = 0; // è€ç”Ÿä»£GCæ¬¡æ•°
  }

  /**
   * åˆ†é…æ–°å¯¹è±¡ï¼ˆæ€»æ˜¯åœ¨æ–°ç”Ÿä»£åˆ†é…ï¼‰
   */
  allocate(id, size, refs = []) {
    console.log(`\nå°è¯•åˆ†é…å¯¹è±¡${id}ï¼ˆå¤§å°ï¼š${size}ï¼‰`);

    // æ£€æŸ¥æ–°ç”Ÿä»£ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
    if (this.youngGen.currentSize + size > this.youngGen.maxSize) {
      console.log('æ–°ç”Ÿä»£ç©ºé—´ä¸è¶³ï¼Œè§¦å‘Minor GC');
      this.minorGC();
    }

    // åœ¨æ–°ç”Ÿä»£Fromç©ºé—´åˆ†é…
    const obj = {
      id,
      size,
      refs,
      age: 0,           // å¯¹è±¡å¹´é¾„
      allocTime: Date.now()
    };

    this.youngGen.fromSpace.set(id, obj);
    this.youngGen.currentSize += size;
    this.allocationCount++;

    console.log(`å¯¹è±¡${id}å·²åœ¨æ–°ç”Ÿä»£åˆ†é…ï¼Œå½“å‰æ–°ç”Ÿä»£ä½¿ç”¨ï¼š${this.youngGen.currentSize}/${this.youngGen.maxSize}`);
  }

  /**
   * æ–°ç”Ÿä»£åƒåœ¾å›æ”¶ï¼ˆMinor GCï¼‰- ä½¿ç”¨å¤åˆ¶ç®—æ³•
   */
  minorGC() {
    console.log('\n=== å¼€å§‹Minor GC ===');
    this.minorGCCount++;

    const survivingObjects = [];
    const promotedObjects = []; // æ™‹å‡åˆ°è€ç”Ÿä»£çš„å¯¹è±¡

    // æ ‡è®°é˜¶æ®µï¼šæ‰¾å‡ºå­˜æ´»å¯¹è±¡
    for (const [id, obj] of this.youngGen.fromSpace) {
      if (this.isReachable(id)) {
        obj.age++; // å¢åŠ å¯¹è±¡å¹´é¾„

        // æ ¹æ®å¹´é¾„å†³å®šæ˜¯å¦æ™‹å‡åˆ°è€ç”Ÿä»£
        if (obj.age >= 3 || this.oldGen.currentSize + obj.size <= this.oldGen.maxSize) {
          if (obj.age >= 3) {
            console.log(`å¯¹è±¡${id}å¹´é¾„è¾¾åˆ°${obj.age}ï¼Œæ™‹å‡åˆ°è€ç”Ÿä»£`);
            promotedObjects.push(obj);
          } else {
            survivingObjects.push(obj);
          }
        } else {
          survivingObjects.push(obj);
        }
      } else {
        console.log(`å¯¹è±¡${id}ä¸å¯è¾¾ï¼Œå°†è¢«å›æ”¶`);
      }
    }

    // æ¸…ç©ºFromç©ºé—´
    this.youngGen.fromSpace.clear();
    this.youngGen.currentSize = 0;

    // å°†å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°Toç©ºé—´
    for (const obj of survivingObjects) {
      this.youngGen.toSpace.set(obj.id, obj);
      this.youngGen.currentSize += obj.size;
    }

    // å°†ç¬¦åˆæ¡ä»¶çš„å¯¹è±¡æ™‹å‡åˆ°è€ç”Ÿä»£
    for (const obj of promotedObjects) {
      this.oldGen.objects.set(obj.id, obj);
      this.oldGen.currentSize += obj.size;
    }

    // äº¤æ¢Fromå’ŒToç©ºé—´
    [this.youngGen.fromSpace, this.youngGen.toSpace] =
    [this.youngGen.toSpace, this.youngGen.fromSpace];

    console.log(`Minor GCå®Œæˆï¼šå­˜æ´»${survivingObjects.length}ä¸ªï¼Œæ™‹å‡${promotedObjects.length}ä¸ª`);
    console.log(`æ–°ç”Ÿä»£ä½¿ç”¨ï¼š${this.youngGen.currentSize}/${this.youngGen.maxSize}`);
    console.log(`è€ç”Ÿä»£ä½¿ç”¨ï¼š${this.oldGen.currentSize}/${this.oldGen.maxSize}`);

    // æ£€æŸ¥æ˜¯å¦éœ€è¦Major GC
    if (this.oldGen.currentSize > this.oldGen.maxSize * 0.8) {
      console.log('è€ç”Ÿä»£ä½¿ç”¨ç‡è¿‡é«˜ï¼Œè§¦å‘Major GC');
      this.majorGC();
    }
  }

  /**
   * è€ç”Ÿä»£åƒåœ¾å›æ”¶ï¼ˆMajor GCï¼‰- ä½¿ç”¨æ ‡è®°-æ¸…é™¤ç®—æ³•
   */
  majorGC() {
    console.log('\n=== å¼€å§‹Major GC ===');
    this.majorGCCount++;

    const beforeSize = this.oldGen.currentSize;

    // æ ‡è®°-æ¸…é™¤ç®—æ³•
    const toDelete = [];
    for (const [id, obj] of this.oldGen.objects) {
      if (!this.isReachable(id)) {
        toDelete.push(id);
        this.oldGen.currentSize -= obj.size;
      }
    }

    // åˆ é™¤åƒåœ¾å¯¹è±¡
    for (const id of toDelete) {
      this.oldGen.objects.delete(id);
      console.log(`è€ç”Ÿä»£å¯¹è±¡${id}è¢«å›æ”¶`);
    }

    const afterSize = this.oldGen.currentSize;
    console.log(`Major GCå®Œæˆï¼šå›æ”¶${beforeSize - afterSize}å•ä½å†…å­˜`);
    console.log(`è€ç”Ÿä»£ä½¿ç”¨ï¼š${afterSize}/${this.oldGen.maxSize}`);
  }

  /**
   * ç®€åŒ–çš„å¯è¾¾æ€§æ£€æŸ¥ï¼ˆå®é™…æƒ…å†µæ›´å¤æ‚ï¼‰
   */
  isReachable(id) {
    // ç®€åŒ–é€»è¾‘ï¼šå¯¹è±¡IDä¸ºå­—æ¯çš„è§†ä¸ºæ ¹å¯¹è±¡ï¼Œæ•°å­—çš„éœ€è¦è¢«å¼•ç”¨
    if (/^[A-Za-z]$/.test(id)) {
      return true; // æ ¹å¯¹è±¡
    }

    // æ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–å¯¹è±¡å¼•ç”¨
    const allObjects = new Map([
      ...this.youngGen.fromSpace,
      ...this.oldGen.objects
    ]);

    for (const obj of allObjects.values()) {
      if (obj.refs.includes(id)) {
        return this.isReachable(obj.id);
      }
    }

    return false;
  }

  /**
   * æ˜¾ç¤ºå½“å‰çŠ¶æ€
   */
  showStatus() {
    console.log('\nå½“å‰åˆ†ä»£çŠ¶æ€ï¼š');
    console.log('æ–°ç”Ÿä»£Fromç©ºé—´ï¼š');
    for (const [id, obj] of this.youngGen.fromSpace) {
      console.log(`  ${id}: å¤§å°${obj.size}, å¹´é¾„${obj.age}, å¼•ç”¨[${obj.refs.join(',')}]`);
    }

    console.log('è€ç”Ÿä»£ï¼š');
    for (const [id, obj] of this.oldGen.objects) {
      console.log(`  ${id}: å¤§å°${obj.size}, å¹´é¾„${obj.age}, å¼•ç”¨[${obj.refs.join(',')}]`);
    }

    console.log(`\nGCç»Ÿè®¡ï¼šMinor GC ${this.minorGCCount}æ¬¡ï¼ŒMajor GC ${this.majorGCCount}æ¬¡`);
  }
}

// ä½¿ç”¨ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿå¯¹è±¡ç”Ÿå‘½å‘¨æœŸ
const genGC = new GenerationalGC();

console.log('=== åˆ†ä»£åƒåœ¾å›æ”¶æ¼”ç¤º ===');

// åˆ†é…ä¸€äº›çŸ­ç”Ÿå‘½å‘¨æœŸå¯¹è±¡
genGC.allocate('A', 2, ['1', '2']); // æ ¹å¯¹è±¡
genGC.allocate('1', 1, []);
genGC.allocate('2', 1, []);

// åˆ†é…æ›´å¤šå¯¹è±¡ï¼Œè§¦å‘Minor GC
genGC.allocate('B', 3, ['3']);
genGC.allocate('3', 2, []);
genGC.allocate('C', 4, []); // è¿™ä¼šè§¦å‘Minor GC

genGC.showStatus();

// ç»§ç»­åˆ†é…ï¼Œè§‚å¯Ÿå¯¹è±¡æ™‹å‡
genGC.allocate('D', 2, []);
genGC.allocate('E', 3, []);
genGC.allocate('F', 2, []); // å†æ¬¡è§¦å‘Minor GC

genGC.showStatus();

// æœ€åæ˜¾ç¤ºåˆ†ä»£å›æ”¶çš„ä¼˜åŠ¿
console.log('\nåˆ†ä»£å›æ”¶çš„ä¼˜åŠ¿ï¼š');
console.log('1. å¤§å¤šæ•°å¯¹è±¡åœ¨æ–°ç”Ÿä»£å°±è¢«å›æ”¶ï¼Œå‡å°‘è€ç”Ÿä»£çš„å‹åŠ›');
console.log('2. æ–°ç”Ÿä»£ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œå›æ”¶é€Ÿåº¦å¿«');
console.log('3. è€ç”Ÿä»£ä½¿ç”¨æ ‡è®°-æ¸…é™¤ï¼Œå¤„ç†é•¿ç”Ÿå‘½å‘¨æœŸå¯¹è±¡');
console.log('4. æ ¹æ®å¯¹è±¡å¹´é¾„è‡ªåŠ¨è°ƒæ•´å›æ”¶ç­–ç•¥');
```

## å®æˆ˜æ¡ˆä¾‹

### JavaScriptä¸­çš„åƒåœ¾å›æ”¶ä¼˜åŒ–

åœ¨V8å¼•æ“ä¸­ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼å‡å°‘GCå‹åŠ›ï¼š
1. **é¿å…å…¨å±€å˜é‡**ï¼šå…¨å±€å¯¹è±¡å­˜æ´»äºè€ç”Ÿä»£ï¼Œé•¿æœŸå ç”¨å†…å­˜ã€‚
   ```javascript
   // åä¾‹ï¼šå…¨å±€å˜é‡
   let globalData = fetchData();

   // æ­£ä¾‹ï¼šå±€éƒ¨å˜é‡
   function processData() {
     const localData = fetchData();
     // ä½¿ç”¨åè‡ªåŠ¨å›æ”¶
   }
   ```
2. **å‡å°‘é—­åŒ…æ»¥ç”¨**ï¼šé—­åŒ…ä¼šæŒæœ‰å¤–å±‚å‡½æ•°å˜é‡çš„å¼•ç”¨ï¼Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚
   ```javascript
   // åä¾‹ï¼šé—­åŒ…é•¿æœŸå¼•ç”¨DOM
   function addClickListener(element) {
     const data = loadLargeData();
     element.addEventListener('click', () => console.log(data));
   }

   // æ­£ä¾‹ï¼šç§»é™¤ä¸å¿…è¦çš„å¼•ç”¨
   function addClickListener(element) {
     const data = loadLargeData();
     const handler = () => console.log(data);
     element.addEventListener('click', handler);
     // å¸è½½æ—¶ç§»é™¤ç›‘å¬å™¨
     return () => element.removeEventListener('click', handler);
   }
   ```

## å…¼å®¹æ€§è¯´æ˜

### ä¸åŒJavaScriptå¼•æ“çš„GCå®ç°

| å¼•æ“ | æµè§ˆå™¨ | ä¸»è¦GCç®—æ³• | ç‰¹è‰²åŠŸèƒ½ |
|------|--------|------------|----------|
| **V8** | Chrome, Edge, Node.js | åˆ†ä»£å›æ”¶ + æ ‡è®°-æ¸…é™¤/æ•´ç† | Orinocoå¹¶è¡ŒGCã€å¢é‡æ ‡è®° |
| **SpiderMonkey** | Firefox | åˆ†ä»£å›æ”¶ + å¢é‡GC | ç²¾ç¡®GCã€åˆ†ç‰‡å›æ”¶ |
| **JavaScriptCore** | Safari | åˆ†ä»£å›æ”¶ + å¹¶å‘GC | DFG/FTLä¼˜åŒ–ã€ä½å»¶è¿ŸGC |
| **Chakra** | IE/æ—§Edge | æ ‡è®°-æ¸…é™¤ + åˆ†ä»£ | åå°GCã€å†…å­˜å‹ç¼© |

### å„å¼•æ“çš„GCç‰¹æ€§å¯¹æ¯”

```javascript
/**
 * @description æ£€æµ‹å½“å‰JavaScriptå¼•æ“çš„GCç‰¹æ€§
 */
function detectGCFeatures() {
  const features = {
    engine: 'unknown',
    hasPerformanceMemory: 'memory' in performance,
    hasGCFunction: typeof gc !== 'undefined',
    hasWeakRef: typeof WeakRef !== 'undefined',
    hasFinalizationRegistry: typeof FinalizationRegistry !== 'undefined'
  };

  // æ£€æµ‹å¼•æ“ç±»å‹
  if (typeof navigator !== 'undefined') {
    const userAgent = navigator.userAgent;
    if (userAgent.includes('Chrome')) {
      features.engine = 'V8 (Chrome)';
    } else if (userAgent.includes('Firefox')) {
      features.engine = 'SpiderMonkey (Firefox)';
    } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
      features.engine = 'JavaScriptCore (Safari)';
    } else if (userAgent.includes('Edge')) {
      features.engine = 'V8 (Edge)';
    }
  } else if (typeof process !== 'undefined' && process.versions?.node) {
    features.engine = 'V8 (Node.js)';
  }

  console.log('JavaScriptå¼•æ“GCç‰¹æ€§æ£€æµ‹:');
  console.log('å¼•æ“:', features.engine);
  console.log('å†…å­˜APIæ”¯æŒ:', features.hasPerformanceMemory ? 'âœ…' : 'âŒ');
  console.log('æ‰‹åŠ¨GCæ”¯æŒ:', features.hasGCFunction ? 'âœ…' : 'âŒ');
  console.log('WeakRefæ”¯æŒ:', features.hasWeakRef ? 'âœ…' : 'âŒ');
  console.log('FinalizationRegistryæ”¯æŒ:', features.hasFinalizationRegistry ? 'âœ…' : 'âŒ');

  return features;
}

// æ‰§è¡Œæ£€æµ‹
detectGCFeatures();

/**
 * @description è·¨å¼•æ“å…¼å®¹çš„å†…å­˜ç›‘æ§
 */
class CrossEngineMemoryMonitor {
  constructor() {
    this.isV8 = typeof performance !== 'undefined' && 'memory' in performance;
    this.hasGC = typeof gc !== 'undefined';
  }

  /**
   * è·å–å†…å­˜ä½¿ç”¨æƒ…å†µï¼ˆè·¨å¼•æ“å…¼å®¹ï¼‰
   */
  getMemoryUsage() {
    if (this.isV8) {
      // V8å¼•æ“ï¼ˆChromeã€Node.jsï¼‰
      const memory = performance.memory;
      return {
        used: memory.usedJSHeapSize,
        total: memory.totalJSHeapSize,
        limit: memory.jsHeapSizeLimit,
        engine: 'V8'
      };
    } else if (typeof process !== 'undefined' && process.memoryUsage) {
      // Node.jsç¯å¢ƒ
      const memory = process.memoryUsage();
      return {
        used: memory.heapUsed,
        total: memory.heapTotal,
        limit: memory.heapTotal * 1.5, // ä¼°ç®—
        rss: memory.rss,
        external: memory.external,
        engine: 'Node.js'
      };
    } else {
      // å…¶ä»–å¼•æ“ï¼Œæ— æ³•ç²¾ç¡®æµ‹é‡
      return {
        used: 0,
        total: 0,
        limit: 0,
        engine: 'Unknown',
        supported: false
      };
    }
  }

  /**
   * å°è¯•è§¦å‘åƒåœ¾å›æ”¶ï¼ˆå¦‚æœæ”¯æŒï¼‰
   */
  triggerGC() {
    if (this.hasGC) {
      gc();
      console.log('å·²è§¦å‘åƒåœ¾å›æ”¶');
      return true;
    } else {
      console.log('å½“å‰ç¯å¢ƒä¸æ”¯æŒæ‰‹åŠ¨è§¦å‘GC');
      return false;
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const crossEngineMonitor = new CrossEngineMemoryMonitor();
console.log('å½“å‰å†…å­˜ä½¿ç”¨:', crossEngineMonitor.getMemoryUsage());

## é¢è¯•å¸¸è§é—®é¢˜

### 1. JavaScriptåƒåœ¾å›æ”¶çš„åŸºæœ¬åŸç†æ˜¯ä»€ä¹ˆï¼Ÿ

**ç­”**ï¼šJavaScriptåƒåœ¾å›æ”¶çš„åŸºæœ¬åŸç†æ˜¯è‡ªåŠ¨è¯†åˆ«å’Œé‡Šæ”¾ç¨‹åºä¸å†ä½¿ç”¨çš„å†…å­˜å¯¹è±¡ã€‚ä¸»è¦åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

1. **å†…å­˜åˆ†é…**ï¼šå½“åˆ›å»ºå¯¹è±¡ã€å˜é‡æˆ–å‡½æ•°æ—¶ï¼ŒJavaScriptå¼•æ“è‡ªåŠ¨åˆ†é…å†…å­˜
2. **ä½¿ç”¨å†…å­˜**ï¼šç¨‹åºå¯¹åˆ†é…çš„å†…å­˜è¿›è¡Œè¯»å†™æ“ä½œ
3. **æ ‡è®°é˜¶æ®µ**ï¼šåƒåœ¾å›æ”¶å™¨ä»æ ¹å¯¹è±¡ï¼ˆå…¨å±€å¯¹è±¡ã€å½“å‰æ‰§è¡Œæ ˆç­‰ï¼‰å¼€å§‹ï¼Œéå†æ‰€æœ‰å¯è¾¾å¯¹è±¡å¹¶æ ‡è®°
4. **æ¸…é™¤é˜¶æ®µ**ï¼šå›æ”¶æ‰€æœ‰æœªæ ‡è®°çš„å¯¹è±¡ï¼Œé‡Šæ”¾å…¶å ç”¨çš„å†…å­˜ç©ºé—´

```javascript
/**
 * @description åƒåœ¾å›æ”¶åŸºæœ¬åŸç†æ¼”ç¤º
 */
function basicGCDemo() {
  // 1. å†…å­˜åˆ†é…
  const obj1 = { name: 'Object 1', data: new Array(1000) };
  const obj2 = { name: 'Object 2', ref: obj1 };

  // 2. ä½¿ç”¨å†…å­˜
  console.log(obj2.ref.name); // è¾“å‡º: Object 1

  // 3. å˜é‡è¶…å‡ºä½œç”¨åŸŸåï¼Œobj1å’Œobj2å˜ä¸ºä¸å¯è¾¾
  // 4. åœ¨ä¸‹æ¬¡GCæ—¶ï¼Œè¿™äº›å¯¹è±¡ä¼šè¢«æ ‡è®°ä¸ºåƒåœ¾å¹¶å›æ”¶
}

basicGCDemo();
// å‡½æ•°æ‰§è¡Œå®Œæ¯•åï¼Œobj1å’Œobj2æˆä¸ºåƒåœ¾ï¼Œç­‰å¾…å›æ”¶

// å…¨å±€å¯¹è±¡ä¼šä¸€ç›´å­˜åœ¨ï¼Œä¸ä¼šè¢«å›æ”¶
const globalObj = { persistent: true };
```

**ç°ä»£åƒåœ¾å›æ”¶å™¨çš„ä¼˜åŒ–**ï¼š
- é‡‡ç”¨åˆ†ä»£å›æ”¶ç­–ç•¥ï¼ŒåŒºåˆ†çŸ­æœŸå’Œé•¿æœŸå¯¹è±¡
- ä½¿ç”¨å¢é‡å’Œå¹¶å‘æŠ€æœ¯ï¼Œå‡å°‘GCåœé¡¿æ—¶é—´
- åŸºäºå¯¹è±¡çš„å­˜æ´»æ—¶é—´è°ƒæ•´å›æ”¶é¢‘ç‡

### 2. ä»€ä¹ˆæ˜¯å†…å­˜æ³„æ¼ï¼Ÿå¦‚ä½•æ£€æµ‹å’Œé¿å…ï¼Ÿ

**ç­”**ï¼šå†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºæ— æ³•é‡Šæ”¾å·²ç»ä¸å†ä½¿ç”¨çš„å†…å­˜ï¼Œå¯¼è‡´å¯ç”¨å†…å­˜ä¸æ–­å‡å°‘ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´ç¨‹åºå´©æºƒã€‚

#### å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯ï¼š

```javascript
/**
 * @description å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ
 */

// 1. æœªæ¸…ç†çš„äº‹ä»¶ç›‘å¬å™¨
class MemoryLeakExamples {
  constructor() {
    this.data = new Array(10000).fill('large data');
  }

  // âŒ é”™è¯¯ï¼šæœªæ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  badEventHandling() {
    const button = document.getElementById('myButton');

    // è¿™ä¸ªåŒ¿åå‡½æ•°ä¼šæŒæœ‰ç»„ä»¶å®ä¾‹çš„å¼•ç”¨
    button.addEventListener('click', () => {
      console.log(this.data.length);
    });

    // å³ä½¿ç»„ä»¶è¢«é”€æ¯ï¼Œç”±äºäº‹ä»¶ç›‘å¬å™¨æœªæ¸…ç†ï¼Œ
    // æ•´ä¸ªç»„ä»¶å®ä¾‹ä»ç„¶è¢«å¼•ç”¨ï¼Œæ— æ³•è¢«å›æ”¶
  }

  // âœ… æ­£ç¡®ï¼šä¸»åŠ¨æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
  goodEventHandling() {
    const button = document.getElementById('myButton');

    const clickHandler = () => {
      console.log(this.data.length);
    };

    button.addEventListener('click', clickHandler);

    // ç»„ä»¶é”€æ¯æ—¶æ¸…ç†
    return () => {
      button.removeEventListener('click', clickHandler);
    };
  }

  // âŒ é”™è¯¯ï¼šæœªæ¸…ç†çš„å®šæ—¶å™¨
  badTimerHandling() {
    setInterval(() => {
      console.log('å®šæ—¶ä»»åŠ¡:', this.data.length);
    }, 1000);

    // å®šæ—¶å™¨æŒæœ‰ç»„ä»¶å¼•ç”¨ï¼Œç»„ä»¶æ— æ³•è¢«å›æ”¶
  }

  // âœ… æ­£ç¡®ï¼šæ¸…ç†å®šæ—¶å™¨
  goodTimerHandling() {
    const intervalId = setInterval(() => {
      console.log('å®šæ—¶ä»»åŠ¡:', this.data.length);
    }, 1000);

    // è¿”å›æ¸…ç†å‡½æ•°
    return () => {
      clearInterval(intervalId);
    };
  }

  // âŒ é”™è¯¯ï¼šé—­åŒ…å¼•ç”¨å¤§å¯¹è±¡
  badClosureHandling() {
    const largeData = new Array(100000).fill('data');

    return function() {
      // è¿™ä¸ªå‡½æ•°æŒæœ‰largeDataçš„å¼•ç”¨
      // å³ä½¿åªéœ€è¦è®¿é—®ä¸€ä¸ªç®€å•å€¼ï¼Œæ•´ä¸ªlargeDataéƒ½æ— æ³•è¢«å›æ”¶
      return largeData.length;
    };
  }

  // âœ… æ­£ç¡®ï¼šé¿å…ä¸å¿…è¦çš„é—­åŒ…å¼•ç”¨
  goodClosureHandling() {
    const largeData = new Array(100000).fill('data');
    const dataLength = largeData.length; // æå–éœ€è¦çš„å€¼

    // è¿”å›çš„å‡½æ•°åªå¼•ç”¨å¿…è¦çš„æ•°æ®
    return function() {
      return dataLength;
    };
  }
}

// 2. DOMå¼•ç”¨å¯¼è‡´çš„å†…å­˜æ³„æ¼
class DOMMemoryLeakDemo {
  constructor() {
    this.elements = new Map();
  }

  // âŒ é”™è¯¯ï¼šä¿å­˜DOMå¼•ç”¨
  badDOMHandling() {
    const element = document.createElement('div');
    element.innerHTML = '<span>å¤§é‡å†…å®¹...</span>'.repeat(1000);

    // å³ä½¿elementä»DOMä¸­ç§»é™¤ï¼Œè¿™é‡Œçš„å¼•ç”¨ä»ç„¶å­˜åœ¨
    this.elements.set('myElement', element);

    document.body.appendChild(element);
  }

  // âœ… æ­£ç¡®ï¼šä½¿ç”¨WeakMapæˆ–åŠæ—¶æ¸…ç†å¼•ç”¨
  goodDOMHandling() {
    const element = document.createElement('div');
    element.innerHTML = '<span>å¤§é‡å†…å®¹...</span>'.repeat(1000);

    // ä½¿ç”¨WeakMapï¼ŒDOMå…ƒç´ è¢«ç§»é™¤æ—¶è‡ªåŠ¨æ¸…ç†
    const elementData = new WeakMap();
    elementData.set(element, { type: 'content', created: Date.now() });

    document.body.appendChild(element);

    // è¿”å›æ¸…ç†å‡½æ•°
    return () => {
      if (element.parentNode) {
        element.parentNode.removeChild(element);
      }
      // WeakMapä¸­çš„æ•°æ®ä¼šè‡ªåŠ¨æ¸…ç†
    };
  }
}
```

#### å†…å­˜æ³„æ¼æ£€æµ‹æ–¹æ³•ï¼š

```javascript
/**
 * @description å†…å­˜æ³„æ¼æ£€æµ‹å·¥å…·
 */
class MemoryLeakDetector {
  constructor() {
    this.baseline = null;
    this.measurements = [];
  }

  /**
   * è®¾ç½®å†…å­˜åŸºçº¿
   */
  setBaseline() {
    if ('memory' in performance) {
      this.baseline = performance.memory.usedJSHeapSize;
      console.log(`å†…å­˜åŸºçº¿è®¾ç½®: ${(this.baseline / 1024 / 1024).toFixed(2)} MB`);
    }
  }

  /**
   * æ£€æµ‹å†…å­˜å¢é•¿
   */
  checkMemoryGrowth(label = '') {
    if (!this.baseline || !('memory' in performance)) {
      console.warn('æ— æ³•æ£€æµ‹å†…å­˜å¢é•¿ï¼šä¸æ”¯æŒæˆ–æœªè®¾ç½®åŸºçº¿');
      return;
    }

    const current = performance.memory.usedJSHeapSize;
    const growth = current - this.baseline;
    const growthMB = growth / 1024 / 1024;

    this.measurements.push({
      label,
      timestamp: Date.now(),
      memory: current,
      growth: growth
    });

    console.log(`å†…å­˜æ£€æµ‹ [${label}]: +${growthMB.toFixed(2)} MB`);

    // è­¦å‘Šé˜ˆå€¼ï¼šå¢é•¿è¶…è¿‡50MB
    if (growthMB > 50) {
      console.warn('âš ï¸ æ£€æµ‹åˆ°æ˜¾è‘—å†…å­˜å¢é•¿ï¼Œå¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼');
    }

    return {
      current: current,
      growth: growth,
      growthMB: growthMB
    };
  }

  /**
   * è¿ç»­ç›‘æ§å†…å­˜å˜åŒ–
   */
  startContinuousMonitoring(interval = 5000, duration = 60000) {
    console.log(`å¼€å§‹è¿ç»­ç›‘æ§ ${duration/1000}ç§’ï¼Œé—´éš”${interval/1000}ç§’`);

    let count = 0;
    const baselineUsage = this.getCurrentMemoryUsage()?.used || 0;

    const monitor = setInterval(() => {
      const current = this.getCurrentMemoryUsage();
      if (current) {
        const increase = current.used - baselineUsage;
        const increasePercent = (increase / baselineUsage * 100).toFixed(2);

        console.log(`ç›‘æ§ç‚¹${++count}: +${(increase / 1024 / 1024).toFixed(2)}MB (${increasePercent}%)`);

        // å†…å­˜å¢é•¿è¶…è¿‡50%æ—¶è­¦å‘Š
        if (increase / baselineUsage > 0.5) {
          console.warn('âš ï¸ æ£€æµ‹åˆ°å¯èƒ½çš„å†…å­˜æ³„æ¼ï¼');
        }
      }
    }, interval);

    // ç›‘æ§ç»“æŸ
    setTimeout(() => {
      clearInterval(monitor);
      this.generateLeakReport();
    }, duration);
  }

  /**
   * ç”Ÿæˆå†…å­˜æ³„æ¼æŠ¥å‘Š
   */
  generateLeakReport() {
    if (this.measurements.length < 2) {
      console.log('æµ‹é‡æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”ŸæˆæŠ¥å‘Š');
      return;
    }

    const first = this.measurements[0];
    const last = this.measurements[this.measurements.length - 1];
    const totalGrowth = last.memory - first.memory;
    const timeSpan = last.timestamp - first.timestamp;
    const avgGrowthRate = totalGrowth / timeSpan * 1000; // bytes/second

    console.log('\n=== å†…å­˜æ³„æ¼æ£€æµ‹æŠ¥å‘Š ===');
    console.log(`ç›‘æ§æ—¶é•¿: ${timeSpan / 1000}ç§’`);
    console.log(`æ€»å†…å­˜å¢é•¿: ${(totalGrowth / 1024 / 1024).toFixed(2)} MB`);
    console.log(`å¹³å‡å¢é•¿ç‡: ${(avgGrowthRate / 1024 / 1024).toFixed(4)} MB/ç§’`);

    // åˆ†æå¢é•¿è¶‹åŠ¿
    const growthTrend = this.measurements.map(m => m.growth);
    const isIncreasing = growthTrend[growthTrend.length - 1] > growthTrend[0];

    if (isIncreasing && avgGrowthRate > 1024 * 1024) { // 1MB/s
      console.warn('ğŸš¨ é«˜é£é™©ï¼šæ£€æµ‹åˆ°æŒç»­å†…å­˜æ³„æ¼');
    } else if (totalGrowth > 50 * 1024 * 1024) { // 50MB
      console.warn('âš ï¸ ä¸­é£é™©ï¼šå†…å­˜ä½¿ç”¨é‡æ˜¾è‘—å¢åŠ ');
    } else {
      console.log('âœ… ä½é£é™©ï¼šå†…å­˜ä½¿ç”¨æ­£å¸¸');
    }
  }
}

// ä½¿ç”¨ç¤ºä¾‹
const detector = new MemoryLeakDetector();
detector.setBaseline();

// æ¨¡æ‹Ÿä¸€äº›æ“ä½œåæ£€æµ‹
setTimeout(() => {
  detector.checkMemoryGrowth('æ“ä½œå');
}, 1000);

// å¯åŠ¨è¿ç»­ç›‘æ§
// detector.startContinuousMonitoring(2000, 10000);
```

#### é¢„é˜²å†…å­˜æ³„æ¼çš„æœ€ä½³å®è·µï¼š

1. **åŠæ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨**
2. **æ¸…ç†å®šæ—¶å™¨å’Œå¼‚æ­¥æ“ä½œ**
3. **é¿å…åˆ›å»ºä¸å¿…è¦çš„é—­åŒ…**
4. **ä½¿ç”¨WeakMap/WeakSetå­˜å‚¨ä¸´æ—¶å…³è”æ•°æ®**
5. **åˆç†ç®¡ç†DOMå¼•ç”¨**
6. **å®šæœŸè¿›è¡Œå†…å­˜ç›‘æ§å’Œæµ‹è¯•**

è¿™äº›ä¼˜åŒ–æŠ€å·§å¯ä»¥æ˜¾è‘—å‡å°‘åƒåœ¾å›æ”¶çš„å‹åŠ›ï¼Œæå‡åº”ç”¨æ€§èƒ½ã€‚